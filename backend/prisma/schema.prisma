// Ramboo Engineering - Garage & Workshop Management System
// Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("staff") // admin, manager, staff, foreman
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobCards      JobCard[]
  posSales      PosSale[]
  dailyUsages   DailyUsage[]
  stockMovements StockMovement[]
}

// ==================== INVENTORY & WAREHOUSE ====================
model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventoryItems InventoryItem[]
}

model InventoryItem {
  id           String   @id @default(uuid())
  sku          String   @unique
  name         String
  description  String?
  categoryId   String
  costPrice    Float
  sellingPrice Float
  currentStock Int      @default(0)
  reorderLevel Int      @default(10)
  unit         String   @default("pcs") // pcs, liters, kg, etc.
  barcode      String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category       Category        @relation(fields: [categoryId], references: [id])
  stockMovements StockMovement[]
  posSaleItems   PosSaleItem[]
  jobParts       JobPart[]
  dailyUsages    DailyUsage[]
}

model StockMovement {
  id              String   @id @default(uuid())
  inventoryItemId String
  type            String   // purchase, sale, job_usage, shop_use, adjustment
  quantity        Int      // positive for in, negative for out
  costPrice       Float?
  reference       String?  // PO number, Invoice number, Job Card number
  notes           String?
  userId          String
  createdAt       DateTime @default(now())

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
}

// ==================== CUSTOMERS & VEHICLES ====================
model Customer {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  email     String?
  address   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles Vehicle[]
  jobCards JobCard[]
  posSales PosSale[]
}

model Vehicle {
  id         String   @id @default(uuid())
  customerId String
  vehicleNo  String
  make       String?
  model      String?
  color      String?
  year       Int?
  vin        String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer  @relation(fields: [customerId], references: [id])
  jobCards JobCard[]
}

// ==================== SERVICE CATALOG ====================
model ServiceCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services Service[]
}

model Service {
  id          String   @id @default(uuid())
  categoryId  String
  name        String
  description String?
  basePrice   Float
  duration    Int?     // estimated duration in minutes
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category ServiceCategory @relation(fields: [categoryId], references: [id])
  jobServices JobService[]
}

// ==================== JOB CARD / WORK ORDER ====================
model JobCard {
  id           String   @id @default(uuid())
  jobNumber    String   @unique
  customerId   String
  vehicleId    String
  odometer     Int?
  status       String   @default("pending") // pending, in_progress, quality_check, ready, invoiced, paid
  notes        String?
  estimatedTotal Float  @default(0)
  actualTotal    Float  @default(0)
  assignedToId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  completedAt  DateTime?
  paidAt       DateTime?

  customer   Customer     @relation(fields: [customerId], references: [id])
  vehicle    Vehicle      @relation(fields: [vehicleId], references: [id])
  assignedTo User?        @relation(fields: [assignedToId], references: [id])
  jobServices JobService[]
  jobParts    JobPart[]
  jobManualEntries JobManualEntry[]
  invoice    Invoice?
}

model JobService {
  id         String   @id @default(uuid())
  jobCardId  String
  serviceId  String
  quantity   Int      @default(1)
  unitPrice  Float
  discount   Float    @default(0)
  total      Float
  notes      String?
  createdAt  DateTime @default(now())

  jobCard JobCard @relation(fields: [jobCardId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])
}

model JobPart {
  id              String   @id @default(uuid())
  jobCardId       String
  inventoryItemId String
  quantity        Int
  unitPrice       Float
  discount        Float    @default(0)
  total           Float
  notes           String?
  createdAt       DateTime @default(now())

  jobCard       JobCard       @relation(fields: [jobCardId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
}

// For Tinkering & Painting - Manual entries
model JobManualEntry {
  id          String   @id @default(uuid())
  jobCardId   String
  description String
  category    String   // tinkering, painting, other
  estimatedCost Float
  actualCost    Float?
  notes       String?
  createdAt   DateTime @default(now())

  jobCard JobCard @relation(fields: [jobCardId], references: [id], onDelete: Cascade)
}

// ==================== INVOICING ====================
model Invoice {
  id           String   @id @default(uuid())
  invoiceNumber String  @unique
  jobCardId    String   @unique
  subtotal     Float
  taxRate      Float    @default(0)
  taxAmount    Float    @default(0)
  discount     Float    @default(0)
  total        Float
  status       String   @default("pending") // pending, paid, partial, cancelled
  paymentMethod String?
  paidAmount   Float    @default(0)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  paidAt       DateTime?

  jobCard  JobCard   @relation(fields: [jobCardId], references: [id])
  payments Payment[]
}

model Payment {
  id        String   @id @default(uuid())
  invoiceId String
  amount    Float
  method    String   // cash, card, transfer, cheque
  reference String?
  notes     String?
  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])
}

// ==================== POINT OF SALE ====================
model PosSale {
  id           String   @id @default(uuid())
  saleNumber   String   @unique
  customerId   String?
  subtotal     Float
  taxRate      Float    @default(0)
  taxAmount    Float    @default(0)
  discount     Float    @default(0)
  total        Float
  paymentMethod String
  paidAmount   Float
  change       Float    @default(0)
  status       String   @default("completed") // completed, refunded
  notes        String?
  userId       String
  createdAt    DateTime @default(now())

  customer Customer?     @relation(fields: [customerId], references: [id])
  user     User          @relation(fields: [userId], references: [id])
  items    PosSaleItem[]
}

model PosSaleItem {
  id              String   @id @default(uuid())
  posSaleId       String
  inventoryItemId String
  quantity        Int
  unitPrice       Float
  discount        Float    @default(0)
  total           Float
  createdAt       DateTime @default(now())

  posSale       PosSale       @relation(fields: [posSaleId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
}

// ==================== DAILY USAGE / SHOP CONSUMABLES ====================
model DailyUsage {
  id              String   @id @default(uuid())
  inventoryItemId String
  quantity        Int
  reason          String   // shop_floor, cleaning, maintenance, other
  notes           String?
  userId          String
  createdAt       DateTime @default(now())

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
}

// ==================== SETTINGS ====================
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
